# CircuitWeaver 🤖🔌 - 一个能自我进化、支持并发的电路设计AI代理系统

CircuitWeaver 是一个先进的、自主化的AI代理系统，其核心任务是从高级概念出发，生成专业的电子电路图。它不仅仅是一个代码生成工具，更实现了一套健壮的、能够自我修复和持续学习的自动化工作流。

本系统采用并发的“工厂”模式运行，能够并行处理多个电路设计任务。当某个代理（Agent）在工作中犯错时，系统会触发一个“集体反思”机制，由一个AI模型团队协同寻找解决方案。成功的修复方案会被一个AI“方案矿工”自动提炼并存入持久化的知识库中，从而使整个系统随着时间的推移变得越来越智能。

---

## ✨ 核心特性

*   **🧠 端到端自动化**: 从电路构思到最终生成带标注的图纸，整个流程完全自主。
*   **🚀 并发代理工厂**: 支持并行运行多个电路设计任务，最大化提升产出效率。
*   **🤝 集体问题解决**: 采用独特的“模型竞速”机制，让多个AI模型竞争修复错误，从而有效提高问题解决的成功率。
*   **📚 自我进化的知识库**: 能够自动捕获并从过去的错误中学习。成功的修复方案会被一个异步的AI“方案矿工”（Solution Miner）总结提炼，并存入本地SQLite数据库以备未来之需。
*   **🔍 混合知识检索**: 创造性地结合了两种知识来源——基于官方文档的静态RAG（检索增强生成）系统，以及系统自身在实践中积累的动态经验知识库。
*   **📦 轻量级安全沙箱**: 使用基于Python `multiprocessing` 的安全本地沙箱来执行和验证生成的代码，避免了Docker等重量级方案的开销。
*   **💾 详尽的产物日志**: 每一次运行，包括所有的尝试、错误、RAG上下文和最终输出（SVG图纸、JSON元数据），都会被一丝不苟地记录在专属的目录中，便于调试和复盘。

## 🏛️ 系统架构

系统由一个多阶段、迭代式的循环进行编排：

1.  **构思 (Ideation)**: 一个AI规划师（Planner）提出一个电路概念，并附上推荐的元件列表。
2.  **代码生成 (Code Generation)**: 一个AI程序员（Coder）尝试编写Python脚本（使用 `schemdraw` 库）来实现该电路概念。
3.  **沙箱执行 (Sandbox Execution)**: 生成的代码在一个安全的本地沙箱中运行。
    *   **若成功**: 流程进入最后阶段。
    *   **若失败**: 启动调试循环。
4.  **集体调试循环 (Collective Debugging Loop)**:
    *   **混合检索**: 代理从**静态文档库**（FAISS向量数据库）和**动态经验库**（SQLite数据库）中同时检索相关上下文。
    *   **模型竞速**: 多个预先配置的AI模型接收到失败的代码、错误信息和检索到的上下文，然后竞争生成一个有效的修复方案。
    *   **验证**: 每个修复方案都会在沙箱中进行测试。
    *   **学习**:
        *   如果某个修复方案**成功**，这个“代码 -> 错误 -> 解决方案”的模式会被发送给一个异步的AI**方案矿工**，由它提炼知识并存入经验库。
        *   如果所有修复方案都**失败**，系统会生成一份详细的“集体失败报告”，并将其添加到对话历史中，以指导下一轮的修复尝试。
5.  **最终产出 (Finalization)**: 一旦生成了可行的脚本，系统会自动为其注入元数据提取代码，并再次运行，最终生成 `circuit.svg` 电路图和一个包含元件与连接信息的 `metadata.json` 文件。

## 🛠️ 安装与设置

请遵循以下步骤来启动并运行CircuitWeaver工厂。

### 1. 环境要求
*   Python 3.10+
*   一个兼容OpenAI的API Key和API服务地址（Endpoint URL）。
*   (可选但强烈推荐) 一块支持CUDA的NVIDIA GPU，用于加速嵌入模型的计算。

### 2. 克隆仓库
```bash
git clone https://github.com/ZhijunLStudio/CircuitWeaver.git
cd CircuitWeaver
```

### 3. 设置环境变量
在项目根目录创建一个 `.env` 文件，或者直接在终端中导出以下环境变量：

```bash
export OPENAI_API_KEY="你的API Key"
export OPENAI_BASE_URL="你的API服务地址"
```

### 4. 安装依赖库

我们强烈建议您先单独安装PyTorch，以确保其版本与您的系统和CUDA环境兼容。

**步骤 4.1: 安装PyTorch**
请访问 [PyTorch官方网站](https://pytorch.org/) 获取适合您系统的安装命令。例如，对于Linux和CUDA 11.8环境：
```bash
pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
```

**步骤 4.2: 安装其余依赖**
```bash
pip install -r requirements.txt
```

### 5. 准备知识库

**步骤 5.1: 放置语料库**
将你的 `schemdraw` 文档文件（`.md` 格式）放入 `corpus/cleaned_markdown_corpus/` 目录下。

**步骤 5.2: 构建向量数据库**
运行此脚本来处理语料库并创建FAISS向量索引。此操作只需执行一次，或者在您更新语料库后再次执行。
```bash
python scripts/build_vector_db.py
```

## 🚀 运行代理工厂

您可以通过命令行参数来控制工厂的运行模式。

**以3个并发代理持续运行（默认模式）:**
*(工厂会不断生成电路，直到您使用 Ctrl+C 停止它)*
```bash
python main.py
```

**以5个并发代理生成总计10个电路:**
```bash
python main.py --num-jobs 10 --workers 5
```

**命令行选项:**
*   `-n, --num-jobs`: 要生成的电路总数。`0` 代表无限生成。(默认: 0)
*   `-w, --workers`: 并发运行的代理数量。(默认: 3)

## ⚙️ 系统配置

核心配置项位于 `configs/` 目录下：

*   **`configs/models.py`**:
    *   `MODEL_FOR_CREATION`: 用于初始创意构思阶段的AI模型。
    *   `MODELS_FOR_FIXING`: 用于“模型竞速”调试阶段的AI模型列表。**在此处配置多个模型（即使是重复相同的模型名称）至关重要，这能有效激发多样性和创造性的问题解决方案。**
    *   `EMBEDDING_MODEL`: 用于RAG的本地Sentence-Transformer模型的路径。
*   **`configs/settings.py`**:
    *   `MAX_DEBUG_ATTEMPTS`: 单个代理在放弃之前尝试修复一段代码的最大次数。
    *   语料库、运行结果和知识库等文件的路径配置。

## 📂 项目结构

```
.
├── configs/              # 模型与应用配置
├── corpus/               # 原始文档与生成的向量数据库
├── knowledge_base/       # 自我进化的经验数据库 (SQLite) 与日志
├── prompts/              # 所有AI代理的提示语
├── results/              # 所有运行的输出目录和产物
├── scripts/              # 辅助脚本 (例如, 构建向量数据库)
├── src/                  # 主要源代码
│   ├── core/             # 编排器, 方案矿工
│   ├── db/               # 知识库管理器
│   ├── sandbox/          # 本地代码执行沙箱
│   ├── tools/            # RAG工具
│   └── utils/            # 辅助工具函数
└── main.py               # 运行工厂的主入口
```